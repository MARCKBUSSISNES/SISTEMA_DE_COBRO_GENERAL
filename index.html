<!doctype html>
<html lang="es">
<head>
<meta charset="utf-8">
<meta name="viewport" content="width=device-width,initial-scale=1">
<title>Sistema de Cobro - MarckBusiness</title>
<style>
  :root{ --green:#075E54; --light:#25D366; --card:#fff; --bg:#f4f7fb; }
  body{font-family:Roboto,Arial,sans-serif;background:var(--bg);margin:0;padding:28px;}
  .wrap{max-width:1100px;margin:auto;display:grid;grid-template-columns:380px 1fr 340px;gap:20px;align-items:start}
  .card{background:var(--card);border-radius:12px;padding:18px;box-shadow:0 8px 24px rgba(0,0,0,0.08)}
  h2{margin:0 0 10px 0;color:var(--green)}
  label{font-size:0.9rem;color:#333}
  input[type=text], input[type=number]{width:100%;padding:10px;margin-top:6px;margin-bottom:12px;border-radius:8px;border:1px solid #ddd;box-sizing:border-box}
  button{background:var(--light);color:#fff;border:none;padding:10px 14px;border-radius:10px;cursor:pointer;font-weight:600}
  .muted{color:#666;font-size:0.9rem}
  .small{font-size:0.85rem}
  ul.list{list-style:none;padding:0;margin:0;max-height:360px;overflow:auto}
  ul.list li{display:flex;justify-content:space-between;padding:8px 6px;border-bottom:1px solid #f0f0f0}
  .product-actions button{margin-left:6px;padding:6px 10px;border-radius:8px}
  table{width:100%;border-collapse:collapse}
  table th, table td{padding:8px;border-bottom:1px solid #eee;text-align:left}
  .right{text-align:right}
  .controls{display:flex;gap:8px}
  .danger{background:#e74c3c}
  .ghost{background:#e0e0e0;color:#333}
  .center{text-align:center}
  .small-note{font-size:0.85rem;color:#555}
</style>
</head>
<body>
<div class="wrap">
  <!-- Panel de productos -->
  <div class="card">
    <h2>Crear / Administrar Productos</h2>
    <div class="small-note">Los productos se guardan localmente en su navegador.</div>

    <label>Nombre del producto</label>
    <input id="p_name" type="text" placeholder="Ej: Polo blanco" />

    <label>Precio (Q)</label>
    <input id="p_price" type="number" min="0" step="0.01" placeholder="0.00" />

    <label>Stock</label>
    <input id="p_stock" type="number" min="0" step="1" placeholder="Cantidad en inventario" />

    <div style="display:flex;gap:8px;flex-wrap:wrap;margin-top:8px">
      <button id="addProductBtn">Agregar producto</button>
      <button id="clearProductsBtn" class="danger">Borrar todo</button>
      <button id="exportProductsBtn" class="ghost">Descargar inventario</button>
    </div>

    <hr />
    <h3 class="small">Productos disponibles</h3>
    <ul id="productsList" class="list"></ul>
  </div>

  <!-- Panel de venta -->
  <div class="card">
    <h2>Panel de venta</h2>
    <table id="cartTable">
      <thead><tr><th>Cant</th><th>Producto</th><th class="right">Precio</th><th class="right">Total</th><th></th></tr></thead>
      <tbody></tbody>
    </table>

    <div style="display:flex;justify-content:space-between;align-items:center;margin-top:12px">
      <div>
        <label>Cliente (opcional)</label>
        <input id="clientName" placeholder="Nombre del cliente" />
      </div>
      <div style="text-align:right">
        <div class="muted">Total</div>
        <div id="cartTotal" style="font-size:1.4rem;font-weight:700">Q0.00</div>
      </div>
    </div>

    <div style="display:flex;gap:8px;margin-top:14px;flex-wrap:wrap">
      <button id="payBtn">Cobrar y Generar ticket</button>
      <button id="clearCartBtn" class="ghost">Limpiar venta</button>
    </div>

    <div class="small-note" style="margin-top:10px">Ticket 80mm imprimible.</div>
  </div>

  <!-- Registro de ventas -->
  <div class="card">
    <h2>Registro de ventas (hoy)</h2>
    <div id="salesListWrap">
      <ul id="salesList" class="list"></ul>
    </div>

    <div style="margin-top:12px;display:flex;justify-content:space-between;align-items:center">
      <div>
        <div class="muted">Ventas hoy</div>
        <div id="salesCount">0</div>
      </div>
      <div style="text-align:right">
        <div class="muted">Total del día</div>
        <div id="salesTotal">Q0.00</div>
      </div>
    </div>

    <div style="display:flex;gap:8px;margin-top:12px;flex-wrap:wrap">
      <button id="printDayTotal">Imprimir total 80mm</button>
      <button id="deleteSales" class="danger">Borrar ventas (hoy)</button>
      <button id="exportSalesBtn" class="ghost">Descargar ventas del día</button>
    </div>

    <div class="small-note" style="margin-top:10px">Nota: borrar ventas elimina solo las ventas del almacenamiento local.</div>
  </div>
</div>

<script>
const KEY_PRODUCTS = 'mb_products_v2';
const KEY_SALES = 'mb_sales_v2';
const KEY_TICKET = 'mb_ticket_counter_v2';

let products = JSON.parse(localStorage.getItem(KEY_PRODUCTS)||'[]');
let sales = JSON.parse(localStorage.getItem(KEY_SALES)||'[]');
let ticketCounter = parseInt(localStorage.getItem(KEY_TICKET)||'1',10);
let cart = [];

const productsList = document.getElementById('productsList');
const addProductBtn = document.getElementById('addProductBtn');
const clearProductsBtn = document.getElementById('clearProductsBtn');
const p_name = document.getElementById('p_name');
const p_price = document.getElementById('p_price');
const p_stock = document.getElementById('p_stock');

const cartTableBody = document.querySelector('#cartTable tbody');
const cartTotalEl = document.getElementById('cartTotal');
const payBtn = document.getElementById('payBtn');
const clearCartBtn = document.getElementById('clearCartBtn');
const clientNameEl = document.getElementById('clientName');

const salesList = document.getElementById('salesList');
const salesCount = document.getElementById('salesCount');
const salesTotal = document.getElementById('salesTotal');
const printDayTotal = document.getElementById('printDayTotal');
const deleteSalesBtn = document.getElementById('deleteSales');

const exportProductsBtn = document.getElementById('exportProductsBtn');
const exportSalesBtn = document.getElementById('exportSalesBtn');

function saveProducts(){ localStorage.setItem(KEY_PRODUCTS, JSON.stringify(products)); }
function saveSales(){ localStorage.setItem(KEY_SALES, JSON.stringify(sales)); }
function saveTicketCounter(){ localStorage.setItem(KEY_TICKET, ticketCounter.toString()); }
function formatQ(v){ return 'Q'+Number(v).toFixed(2); }
function todayKey(date=new Date()){ return new Date(date.getFullYear(), date.getMonth(), date.getDate()).toISOString().slice(0,10); }

function renderProducts(){
  productsList.innerHTML='';
  if(products.length===0){ productsList.innerHTML='<li class="center muted">No hay productos aún.</li>'; return; }
  products.forEach((p,idx)=>{
    const stockText = p.stock!==undefined ? ` · Stock: ${p.stock}` : '';
    const stockClass = (p.stock===0) ? 'muted' : '';
    const li = document.createElement('li');
    li.innerHTML=`<div><strong>${p.name}</strong><div class="muted small ${stockClass}">Precio: ${formatQ(p.price)}${stockText}</div></div>
                  <div class="product-actions">
                    <button onclick="addToCart(${idx})" ${p.stock===0?'disabled':''}>Agregar</button>
                    <button onclick="editProduct(${idx})" class="ghost">Editar</button>
                    <button onclick="deleteProduct(${idx})" class="danger">Eliminar</button>
                  </div>`;
    productsList.appendChild(li);
  });
}

// Funciones de agregar, editar y eliminar productos
addProductBtn.addEventListener('click', ()=>{
  const name = (p_name.value||'').trim();
  const price = parseFloat(p_price.value)||0;
  const stock = p_stock.value!==''?parseInt(p_stock.value,10):0;
  if(!name){ alert('Ingrese nombre del producto'); return; }
  products.push({name, price, stock});
  saveProducts(); renderProducts(); p_name.value=''; p_price.value=''; p_stock.value='';
});

clearProductsBtn.addEventListener('click', ()=>{ if(confirm('¿Borrar TODOS los productos?')){ products=[]; saveProducts(); renderProducts(); } });

exportProductsBtn.addEventListener('click', ()=>{
  const blob = new Blob([JSON.stringify(products,null,2)], {type:"application/json"});
  const url = URL.createObjectURL(blob);
  const a = document.createElement('a'); a.href=url; a.download='inventario.json'; a.click(); URL.revokeObjectURL(url);
});

// Funciones de carrito
function renderCart(){
  cartTableBody.innerHTML='';
  if(cart.length===0){ cartTableBody.innerHTML='<tr><td colspan="5" class="center muted">Carrito vacío</td></tr>'; cartTotalEl.textContent='Q0.00'; return; }
  let total=0; 
  cart.forEach((item,i)=>{
    const lineTotal = item.qty*item.price;
    total+=lineTotal;
    const tr=document.createElement('tr');
    tr.innerHTML=`<td>${item.qty}</td><td>${item.name}</td><td class="right">${formatQ(item.price)}</td><td class="right">${formatQ(lineTotal)}</td>
                  <td><button onclick="removeFromCart(${i})" class="danger">X</button></td>`;
    cartTableBody.appendChild(tr);
  });
  cartTotalEl.textContent=formatQ(total);
}

function addToCart(idx){
  const prod = products[idx];
  let qty = 1;
  const cartItem = cart.find(c=>c.idx===idx);
  if(cartItem){ qty = cartItem.qty + 1; if(qty>prod.stock){ alert('No hay suficiente stock'); return; cartItem.qty=prod.stock; } else { cartItem.qty=qty; } }
  else{ if(prod.stock===0){ alert('No hay stock disponible'); return; } cart.push({idx, name:prod.name, price:prod.price, qty:1}); }
  renderCart();
}

function removeFromCart(i){ cart.splice(i,1); renderCart(); }

clearCartBtn.addEventListener('click', ()=>{ if(confirm('Limpiar carrito?')){ cart=[]; renderCart(); } });

// Función para cobrar y actualizar stock
payBtn.addEventListener('click', ()=>{
  if(cart.length===0){ alert('Carrito vacío'); return; }
  const cliente = clientNameEl.value.trim();
  let total=0;
  const ventaItems = cart.map(item=>{
    const prod = products[item.idx];
    if(item.qty>prod.stock){ alert(`Producto ${prod.name} no tiene suficiente stock`); return; }
    prod.stock -= item.qty;
    saveProducts(); renderProducts();
    const lineTotal = item.qty*item.price;
    total+=lineTotal;
    return {name:item.name, qty:item.qty, price:item.price, total:lineTotal};
  });
  sales.push({ticket:ticketCounter, client:cliente, items:ventaItems, total:total, date:new Date().toISOString()});
  saveSales();
  ticketCounter++; saveTicketCounter();
  cart=[]; renderCart(); renderSales();
  alert('Venta registrada correctamente');
});

function renderSales(){
  salesList.innerHTML='';
  if(sales.length===0){ salesList.innerHTML='<li class="center muted">No hay ventas hoy</li>'; salesCount.textContent='0'; salesTotal.textContent='Q0.00'; return; }
  let totalDia=0;
  sales.forEach(s=>{
    totalDia+=s.total;
    const li = document.createElement('li');
    li.innerHTML=`<strong>Ticket ${s.ticket}</strong> ${s.client?'- '+s.client:''} <div class="right">${formatQ(s.total)}</div>`;
    salesList.appendChild(li);
  });
  salesCount.textContent=sales.length;
  salesTotal.textContent=formatQ(totalDia);
}

deleteSalesBtn.addEventListener('click', ()=>{ if(confirm('Borrar todas las ventas del día?')){ sales=[]; saveSales(); renderSales(); } });

exportSalesBtn.addEventListener('click', ()=>{
  if(sales.length===0){ alert('No hay ventas para exportar'); return; }
  const headers=['Ticket','Cliente','Producto','Cantidad','Precio','Total','Fecha'];
  const rows = [];
  sales.forEach(s=>{ s.items.forEach(i=>{ rows.push([s.ticket,s.client||'',i.name,i.qty,i.price,i.total,s.date]); }); });
  const csv = [headers.join(','), ...rows.map(r=>r.join(','))].join('\n');
  const blob = new Blob([csv], {type:'text/csv'});
  const url = URL.createObjectURL(blob);
  const a = document.createElement('a'); a.href=url; a.download=`ventas_${todayKey()}.csv`; a.click(); URL.revokeObjectURL(url);
});

// Inicializar
renderProducts(); renderCart(); renderSales();
</script>

<div style="text-align:center;margin-top:20px;font-size:0.8rem;color:#888">
  MarckBusiness © 2025 — Todos los derechos reservados
</div>
</body>
</html>
