<!doctype html>
<html lang="es">
<head>
<meta charset="utf-8">
<meta name="viewport" content="width=device-width,initial-scale=1">
<title>Sistema de Cobro - MarckBusiness</title>
<link href="https://fonts.googleapis.com/css2?family=Roboto+Mono:wght@400;700&display=swap" rel="stylesheet">
<script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>
<style>
  :root{
    --green:#25D366;
    --dark:#121212;
    --dark-card:#1E1E1E;
    --light:#f4f4f4;
    --accent:#03dac6;
  }
  body{
    font-family:'Roboto Mono', monospace;
    background:var(--dark);
    color:var(--light);
    margin:0;padding:20px;
  }
  h2,h3{margin:0 0 10px 0;color:var(--green);}
  .wrap{
    display:grid;
    grid-template-columns:1fr 1fr 1fr;
    gap:20px;
    max-width:1400px;
    margin:auto;
    align-items:start;
  }
  .card{
    background:var(--dark-card);
    border-radius:16px;
    padding:20px;
    box-shadow:0 8px 20px rgba(0,0,0,0.5);
  }
  label{font-size:0.85rem;color:#aaa;}
  input[type=text], input[type=number]{
    width:100%;padding:10px;margin:6px 0 12px 0;border-radius:10px;
    border:1px solid #333;background:var(--dark);color:var(--light);box-sizing:border-box;
  }
  button{
    background:var(--green);
    color:#fff;
    border:none;padding:10px 16px;
    border-radius:12px;
    cursor:pointer;
    font-weight:700;
    transition:0.3s;
  }
  button:hover{background:var(--accent);}
  .danger{background:#e74c3c;}
  .danger:hover{background:#ff5252;}
  .ghost{background:#333;color:#fff;}
  .ghost:hover{background:#555;}
  ul.list{list-style:none;padding:0;margin:0;max-height:380px;overflow:auto;}
  ul.list li{display:flex;justify-content:space-between;padding:10px;border-bottom:1px solid #333;border-radius:8px;margin-bottom:6px;}
  table{width:100%;border-collapse:collapse;}
  table th, table td{padding:10px;text-align:left;border-bottom:1px solid #333;}
  .right{text-align:right;}
  .center{text-align:center;}
  .small-note{font-size:0.8rem;color:#888;}
</style>
</head>
<body>
<div class="wrap">
  <!-- Panel productos -->
  <div class="card">
    <h2>Productos</h2>
    <label>Nombre</label><input id="p_name" type="text" placeholder="Ej: Polo blanco"/>
    <label>Precio (Q)</label><input id="p_price" type="number" min="0" step="0.01"/>
    <label>Stock</label><input id="p_stock" type="number" min="0" step="1"/>
    <div style="display:flex;gap:8px;flex-wrap:wrap;">
      <button id="addProductBtn">Agregar</button>
      <button id="clearProductsBtn" class="danger">Borrar todo</button>
      <button id="exportProductsBtn" class="ghost">Descargar inventario PDF</button>
    </div>
    <hr/>
    <h3>Productos disponibles</h3>
    <ul id="productsList" class="list"></ul>
  </div>

  <!-- Panel venta -->
  <div class="card">
    <h2>Venta</h2>
    <table id="cartTable">
      <thead><tr><th>Cant</th><th>Producto</th><th class="right">Precio</th><th class="right">Total</th><th></th></tr></thead>
      <tbody></tbody>
    </table>
    <div style="display:flex;justify-content:space-between;align-items:center;margin-top:12px">
      <input id="clientName" placeholder="Cliente (opcional)" style="flex:1;margin-right:10px;"/>
      <div class="right">
        <div class="small-note">Total</div>
        <div id="cartTotal" style="font-size:1.4rem;font-weight:700">Q0.00</div>
      </div>
    </div>
    <div style="display:flex;gap:8px;margin-top:12px;">
      <button id="payBtn">Cobrar</button>
      <button id="clearCartBtn" class="ghost">Limpiar</button>
    </div>
    <div class="small-note">Ticket 80mm imprimible.</div>
  </div>

  <!-- Registro ventas -->
  <div class="card">
    <h2>Ventas hoy</h2>
    <ul id="salesList" class="list"></ul>
    <div style="display:flex;justify-content:space-between;align-items:center;margin-top:12px">
      <div><div class="small-note">Ventas</div><div id="salesCount">0</div></div>
      <div class="right"><div class="small-note">Total</div><div id="salesTotal">Q0.00</div></div>
    </div>
    <div style="display:flex;gap:8px;margin-top:12px;flex-wrap:wrap">
      <button id="deleteSales" class="danger">Borrar ventas</button>
    </div>
  </div>
</div>

<div style="text-align:center;margin-top:20px;font-size:0.8rem;color:#888">
  MarckBusiness © 2025 — Todos los derechos reservados
</div>

<script>
const { jsPDF } = window.jspdf;

const KEY_PRODUCTS = 'mb_products_pdf';
const KEY_SALES = 'mb_sales_pdf';
const KEY_TICKET = 'mb_ticket_counter_pdf';
let products = JSON.parse(localStorage.getItem(KEY_PRODUCTS)||'[]');
let sales = JSON.parse(localStorage.getItem(KEY_SALES)||'[]');
let ticketCounter = parseInt(localStorage.getItem(KEY_TICKET)||'1',10);
let cart = [];

const productsList = document.getElementById('productsList');
const addProductBtn = document.getElementById('addProductBtn');
const clearProductsBtn = document.getElementById('clearProductsBtn');
const exportProductsBtn = document.getElementById('exportProductsBtn');
const p_name = document.getElementById('p_name');
const p_price = document.getElementById('p_price');
const p_stock = document.getElementById('p_stock');

const cartTableBody = document.querySelector('#cartTable tbody');
const cartTotalEl = document.getElementById('cartTotal');
const payBtn = document.getElementById('payBtn');
const clearCartBtn = document.getElementById('clearCartBtn');
const clientNameEl = document.getElementById('clientName');

const salesList = document.getElementById('salesList');
const salesCount = document.getElementById('salesCount');
const salesTotal = document.getElementById('salesTotal');
const deleteSalesBtn = document.getElementById('deleteSales');

function saveProducts(){ localStorage.setItem(KEY_PRODUCTS, JSON.stringify(products)); }
function saveSales(){ localStorage.setItem(KEY_SALES, JSON.stringify(sales)); }
function saveTicketCounter(){ localStorage.setItem(KEY_TICKET, ticketCounter.toString()); }
function formatQ(v){ return 'Q'+Number(v).toFixed(2); }

function renderProducts(){
  productsList.innerHTML='';
  if(products.length===0){ productsList.innerHTML='<li class="center small-note">No hay productos</li>'; return;}
  products.forEach((p,idx)=>{
    const li = document.createElement('li');
    const stockClass = (p.stock===0?'small-note':'');
    li.innerHTML=`<div><strong>${p.name}</strong> <span class="${stockClass}">(${p.stock})</span><br><span class="small-note">${formatQ(p.price)}</span></div>
    <div style="display:flex;gap:6px">
      <button onclick="addToCart(${idx})" ${p.stock===0?'disabled':''}>Agregar</button>
      <button onclick="deleteProduct(${idx})" class="danger">Eliminar</button>
    </div>`;
    productsList.appendChild(li);
  });
}

addProductBtn.onclick = ()=>{
  const name = p_name.value.trim(); const price = parseFloat(p_price.value)||0; const stock = parseInt(p_stock.value)||0;
  if(!name){alert('Nombre requerido');return;}
  products.push({name,price,stock});
  saveProducts(); renderProducts();
  p_name.value=''; p_price.value=''; p_stock.value='';
};
clearProductsBtn.onclick = ()=>{ if(confirm('Borrar todos los productos?')){products=[];saveProducts();renderProducts();} };
function deleteProduct(idx){ products.splice(idx,1); saveProducts(); renderProducts(); }

function renderCart(){
  cartTableBody.innerHTML=''; if(cart.length===0){cartTableBody.innerHTML='<tr><td colspan="5" class="center small-note">Carrito vacío</td></tr>';cartTotalEl.textContent='Q0.00'; return;}
  let total=0; cart.forEach((item,i)=>{const line=item.price*item.qty; total+=line;
    const tr=document.createElement('tr');
    tr.innerHTML=`<td>${item.qty}</td><td>${item.name}</td><td class="right">${formatQ(item.price)}</td><td class="right">${formatQ(line)}</td><td><button onclick="removeFromCart(${i})" class="danger">X</button></td>`;
    cartTableBody.appendChild(tr);
  });
  cartTotalEl.textContent=formatQ(total);
}

function addToCart(idx){
  const prod = products[idx]; if(prod.stock===0){alert('Sin stock');return;}
  const exist = cart.find(c=>c.idx===idx);
  if(exist){ if(exist.qty+1>prod.stock){alert('No hay suficiente stock');return;} exist.qty++; } 
  else{ cart.push({idx,name:prod.name,price:prod.price,qty:1}); }
  renderCart();
}
function removeFromCart(i){ cart.splice(i,1); renderCart(); }

clearCartBtn.onclick = ()=>{ if(confirm('Limpiar carrito?')){cart=[];renderCart();} }

payBtn.onclick = ()=>{
  if(cart.length===0){alert('Carrito vacío'); return;}
  const client = clientNameEl.value.trim();
  let totalVenta=0;
  const ventaItems = cart.map(item=>{
    const prod=products[item.idx];
    if(item.qty>prod.stock){alert(`Stock insuficiente: ${prod.name}`); return;}
    prod.stock -= item.qty; totalVenta+=item.qty*item.price; return {...item};
  });
  saveProducts(); renderProducts();
  sales.push({ticket:ticketCounter,client,items:ventaItems,total:totalVenta,date:new Date().toISOString()});
  saveSales(); ticketCounter++; saveTicketCounter(); cart=[]; renderCart(); renderSales();
  alert('Venta registrada');
}

function renderSales(){
  salesList.innerHTML=''; if(sales.length===0){salesList.innerHTML='<li class="center small-note">No hay ventas hoy</li>'; salesCount.textContent='0'; salesTotal.textContent='Q0.00'; return;}
  let totalDia=0;
  sales.forEach(s=>{totalDia+=s.total; const li=document.createElement('li'); li.innerHTML=`Ticket ${s.ticket} ${s.client?'- '+s.client:''} <span class="right">${formatQ(s.total)}</span>`; salesList.appendChild(li);});
  salesCount.textContent=sales.length; salesTotal.textContent=formatQ(totalDia);
}
deleteSalesBtn.onclick = ()=>{ if(confirm('Borrar ventas del día?')){sales=[];saveSales();renderSales();} }

exportProductsBtn.onclick = ()=>{
  if(products.length===0){alert('No hay productos'); return;}
  const doc = new jsPDF(); doc.setFontSize(18); doc.text("Inventario MarckBusiness",14,20);
  doc.setFontSize(12); doc.text(`Fecha: ${new Date().toLocaleDateString()}`,14,28);
  let y=36; doc.setFontSize(11);
  products.forEach((p,i)=>{
    doc.text(`${i+1}. ${p.name}`,14,y); doc.text(`Precio: ${formatQ(p.price)}`,120,y); doc.text(`Stock: ${p.stock}`,160,y); y+=8;
  });
  doc.setFontSize(10); doc.text("MarckBusiness © 2025 — Todos los derechos reservados",14,280);
  doc.save('inventario_marckbusiness.pdf');
}

// Inicializar
renderProducts(); renderCart(); renderSales();
</script>
</body>
</html>
